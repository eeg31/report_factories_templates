---
title: "Investigation of alerts data: Goma"
author: "Charlie Whittaker, Thibaut Jombart, Flavio Finger, Christopher Jarvis, Jonathan Polonsky, Patrick Keating, and Amy Gimma for the analytic cell OEC Goma"
date: "`r format(Sys.time(), '%A %d %B %Y')`"
output:
  html_document: 
    code_folding: hide
    highlight: zenburn
    number_sections: yes
    theme: spacelab
    toc: yes
    toc_collapse: no
    toc_depth: 1
    toc_float: yes
    css: !expr here::here('css', 'style.css')
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      collapse = TRUE,
                      fig.width = 8,
                      fig.height = 6, 
                      dpi = 150,
                      warning = FALSE,
                      message = FALSE,
                      fig.path = "figures/")
```

<!-- ======================================================= -->
<!-- ======================================================= -->
<!-- ======================================================= -->

# Data preparation {.tabset .tabset-fade .tabset-pills}

## Outline

This report cleans and analyses the alert data of Goma. Input comes from an
`xlsx` file containing alerts in a specific format. Because all
sub-coordinations have different standards, each sub-coordination needs a
separate report.

The data preparation involves the following steps, detailed in the following 
tabs:

* **Load scripts**: loads libraries and useful scripts used in the analyses; all
  `.R` files contained in `scripts` at the root of the factory are automatically
  loaded

* **Load data**: imports datasets, and may contain some *ad hoc* changes to the
data such as specific data cleaning (not used in other reports), new variables
used in the analyses, etc.

* **Clean data**: this section contains *ad hoc* data cleaning, i.e. which is
  not used in other reports (otherwise cleaning should be done in a dedicated
  report); this section is also used to create new variables used in the
  analyses

## Load scripts

These scripts will load:

* all local scripts, stored as `.R` filesinside `/scripts/`
* all Overall scripts, i.e. stored outside the factory in `../scripts/`

```{r read_scripts}

## read scripts
path_to_scripts <- here::here("scripts")
scripts_files <- dir(path_to_scripts, pattern = ".R$",
                     full.names = TRUE)
for (file in scripts_files) source(file, local = TRUE)

ggthemr("fresh")

```

## Load alerts data

We extract the completion date from the file name:

```{r load_alerts_data}

## load the data
current_goma
x_raw <- custom_import(current_goma)
glimpse(x_raw)

## extract database date from the file name
file_name <- gsub("^[^.]+/", "", current_goma)
database_date <- file_name %>%
  guess_dates()
database_date

```

The **completion date** of the database is **`r format(database_date, format =
"%A %d %b %Y")`**.


## Clean data

We use *linelist*'s function `clean_data()` to:

- remove all special characters from the data
- set all characters to lower case
- replace all accentuated and diacritic characters with their closest ascii
  match in the latin alphabet
- replace all separators with a single `_`
- replace all mis-spelling using a Overall dictionary (see the file
  `cleaning_rules.xlsx` in `/dictionary/`, or type `cleaning_rules` in this R
  session, after compiling the document
- (optionally) detect date formats and convert data to dates, including cases
  where format varies within a column
  

This cleaning is achieved with:

```{r data_cleaning}

x <- x_raw %>%
  clean_data(guess_dates = FALSE,
             wordlists = cleaning_rules) %>%
  as_tibble()

```


## Renaming variables and sanity checks

The following variables will be used, and are therefore checked:

- `date`: check no date is after the database completion, filtered for NA values after running `guess_dates`
- sanitize `genre`
- make `origin` as a sanitized version of `source_notif`

```{r check_variables}

## date of notification
x <- x %>% mutate(date = guess_dates(date))
range(x$date, na.rm = TRUE)

# REVIEW: Remove NA dates
date_na <- sum(is.na(x$date))
x <- x %>% filter(!is.na(date))
# Check that na dates are removed
sum(is.na(x$date))

## gender
table(x$sexe, useNA = "ifany")

## contact connu
x <- mutate(x, contact_connu = lien_epi)
table(x$contact_connu, useNA = "ifany")

## zone de sante
x <- mutate(x, zone_de_sante = as.character(zone_sante)) 
table(x$zone_de_sante, useNA = "ifany")

## aire de sante
x <- mutate(x, aire_de_sante = as.character(aire_sante)) 
table(x$aire_de_sante, useNA = "ifany")

## origin / source_notif
x <- mutate(x, origin = type_surveillance)
table(x$origin, useNA = "ifany")

# create variable for alert validation
x <- x %>% mutate(
  status = ifelse(result_invest == "inconnu", "statut_inconnu", result_invest)) %>%
  mutate(status = factor(status, levels = c("statut_inconnu", 
                                            "invalidee", 
                                            "validee")))
table(x$status, useNA = "ifany")

# another round of cleaning 
x <- x %>%
  clean_variable_spelling(wordlists = cleaning_rules)

```

## Variable Creation

The following variables are created: 
- `bleed` - which describes whether the alert displayed any of the bleeding related
symptoms.
- `epiweek_report` & `epiweek_report_label` - which describe the epiweek the alert
was reported in.
- `top_zones` - which describes the 3 most active Zone de Santes (other Zone de 
Santes) are grouped into "other".
- `top_aires` - which describes the 14 most active Aire de Santes (out of all the
legitimate Aire de Santes belonging to Goma present in the database). Note - All 
other Aire de Santes are aggregated into the category "other".

Note - All other Aire de Santes are aggregated into the category "other".

**Note:** To emphasise, the ranking of top Aire de Santes is done only on those Aire 
de Santes that legitimately belong to Goma. Those that do not belong to Goma or are
not Aire de Santes at all, are not included when it comes to plotting the Aire de Santes
with the most alerts. However, these alerts ARE included when it comes to plotting the
number of alerts by Sous-Coordination or Zone de Sante (assuming they have a legitimate
Zone de Sante inputted).

For the purposes of plotting by Aire de Sante, we first have to remove (filter) all 
instances in the data where individuals have been erroneously assigned to either
an Aire de Sante that does not belong to Goma, or that is not an Aire de Sante. Once
this filtering step is done, we then create a new variable using `top_values`:


``` {r variable_creation}

## bleed
bleed <- x %>%
  select(contains("saignement")) %>%
  apply(1, function(e) ifelse(any(e == "oui"), "oui", "non"))
x <- mutate(x, bleed = bleed)
table(x$bleed, useNA = "ifany")

## epiweek report
x <- x %>%
  mutate(epiweek_report = 
           aweek::date2week(date, week_start = "Monday", floor_day = TRUE)) %>%
  mutate(epiweek_report_label = 
           aweek::week2date(date, week_start = "Monday", floor_day = TRUE)) 



x <- x %>% 
  mutate(top_zones = top_values(zone_de_sante, 5)) %>%
  mutate(top_aires = top_values(aire_de_sante, 14))
```

One last round of dictionary-based cleaning:

```{r last_cleaning}

x <- x %>%
  clean_variable_spelling(wordlists = cleaning_rules)

```


## Outcomes

Outcome is defined for alerts which have either been validated or invalidated.

```{r outcomes}

## get only known outcomes
outcomes <- x %>%
  filter(status %in% c("validee", "invalidee")) %>%
  droplevels() %>% 
  mutate(validee = 1 * (status == "validee"))

```


## Expected decisions

Alerts are supposed to be validated using the following key, depending on
whether the person has:

1. **known contact** with a case and at least **one symptom**
2. if not 1, **unexplained bleeding**
3. if not 2, **fever and 3 other symptoms**

Note that 3 de facto excludes bleeding as a candidate symptom. We create a new
variable which asserts these conditions:

```{r expected_result}

## elements of diagnostic
## criteria 1
has_contact <- outcomes$contact_connu %in% c("confirme", "oui")
has_one_symptom <- outcomes %>%
  select(fievre,
         nausee_vom,
         diarrhee,
         fatigue,
         anorexie,
         dlr_abdo,
         dlr_thorax,
         dlr_muscu,
         dlr_artic,
         cephalee,
         toux,
         dyspnee,
         dysphagie,
         odynophagie,
         hoquet,
         bleed) %>%
  apply(1, function(e) any(e == "oui", na.rm = TRUE))
fits_1 <- has_contact & has_one_symptom

## criteria 2
has_bleeding <- outcomes$bleed == "oui"
fits_2 <- !fits_1 & has_bleeding

## criteria 3
has_fever <- outcomes$fievre == "oui"
has_3_symptoms <- outcomes %>%
    select(nausee_vom,
         diarrhee,
         fatigue,
         anorexie,
         dlr_abdo,
         dlr_thorax,
         dlr_muscu,
         dlr_artic,
         cephalee,
         toux,
         dyspnee,
         dysphagie,
         odynophagie,
         hoquet,
         bleed) %>% 
  apply(1, function(e) sum(e == "oui", na.rm = TRUE)) >= 3
fits_3 <- !fits_1 & !fits_2 & has_fever & has_3_symptoms


## make sure criteria are exclusive - no number in the table below should exceed
## 1. i.e this table should only zero or one as categories.
table(fits_1 + fits_2 + fits_3)

## expected decisions
outcomes <- outcomes %>%
  mutate(admit_contact = fits_1,
         admit_bleeding = fits_2,
         admit_fever = fits_3) %>% 
  mutate(expected_decision = ifelse(
             fits_1 | fits_2 | fits_3,
             "validee",
             "invalidee"),
         decision_comparison = case_when(
             status == "validee" & expected_decision == "validee" ~
               "true_positive",
             status == "invalidee" & expected_decision == "invalidee" ~
               "true_negative",
             status == "validee" & expected_decision == "invalidee" ~
               "false_positive",
             status == "invalidee" & expected_decision == "validee" ~
               "false_negative",
             TRUE ~ NA_character_
             ),
         decision_comparison =
           factor(decision_comparison,
                  levels = c("true_positive",
                             "true_negative",
                             "false_positive",
                             "false_negative")))

## remove alerts with missing comparisons, from 2019
outcomes <- outcomes %>%
  filter(!is.na(decision_comparison),
         date >= as.Date("2019-01-01"))


## check that classification is well-made
outcomes %>%
  group_by(status, expected_decision, decision_comparison) %>%
  count()


```


## Last 21 days

We duplicate the previous datasets, retaining the 21 days leading up to the
current database date.

```{r subset_21_days}

start_date <- database_date - 21
x_recent <- filter(x, date >= start_date)
outcomes_recent <- filter(outcomes, date >= start_date)

```


## Custom color scales

We define custom colors for some of the variables used in the plots.

```{r scales_fill}

scale_origins <- scale_fill_manual(
  "Origine",
  values = c(communautaire = "#ffcc00",
             recherche_active = "#c3c388",
             surveillance_passive = "#ff6699",
             point_entree = "#40bf80",
             autre = "#668cff",
             inconnu = "grey",
             check_cleaning_rules = "grey"))

scale_decisions <- scale_fill_manual(
    "Décisions",
    values = c(true_positive = "#94b8b8",
               true_negative = "#8c8cd9",
               false_positive = "#ff8080",
               false_negative = "#b3003b"),
    labels = c(true_positive = "vrai positif",
               true_negative = "vrai négatif",
               false_positive = "faux positif",
               false_negative = "faux négatif"))

scale_validations <- scale_fill_manual(
    "Outcome",
    values = c(statut_inconnu = "#BCB4A4", 
               validee = "#D56F3E", 
               invalidee = "#F2C69B"),
    labels = c(validee = "Validée", 
               invalidee = "Invalidée", 
               statut_inconnu = "Statut Inconnu"))

```


<!-- ======================================================= -->
<!-- ======================================================= -->
<!-- ======================================================= -->


# Validation status {.tabset .tabset-fade .tabset-pills}

## Outline

This section summarises alerts over time according to their validation status i.e. whether they were validated or invalidated.

**Note: The Top 3 Health Zones and all Valid Aire de Santes that have reported**
**alerts at any point are plotted when considering totals by geographical area**
**(aggregated over time). The Top 3 Health Zones and the Top 14 Aire de Santes**
**are plotted when it comes to plotting over time (due to space constraints).**

## Overall 

### Weekly, Since Database Start

```{r sous_coord_time}

ggplot(x, aes(x = date, fill = status)) +
  geom_histogram(binwidth = 7, col = "white") +
  scale_validations + 
  labs(x = "",
       y = "Nombre d'alertes par semaine",
       title = paste0("Nombre d'alertes par statut de validation - Goma")) +
  large_txt +
  rotate_x_text(45) + 
  scale_months +
  theme(legend.position = "bottom")

```


### Table - Weekly Since Database Start

```{r sous_coord_time_table, fig.keep = "all"}

table_validation_overall_time <- x %>%
  group_by(epiweek_report, status) %>%
  summarise(count = n()) %>%
  complete(status) %>%
  spread(status, count, fill = 0) %>%
  adorn_totals(where = c("row", "col"))

table_validation_overall_time %>%
 show_table()
  
```

## Overall Past 3 Weeks

### Daily, Past 3 Weeks

```{r sous_coord_recent}

ggplot(x_recent, aes(x = date, fill = status)) +
  geom_histogram(binwidth = 1, col = "white") +
  scale_validations + 
  labs(x = "",
       y = "Nombre d'alertes par jour",
       title = paste0("Nombre d'alertes par statut de validation - Goma")) +
  large_txt +
  rotate_x_text(45) +
  scale_weeks +
  theme(legend.position = "bottom")

```

### Table - Daily Past 3 Weeks 

```{r sous_coord_recent_table, fig.keep = "all"}

table_validation_overall_past_3_weeks <- x_recent %>%
  group_by(date, status) %>%
  summarise(count = n()) %>%
  complete(status) %>%
  spread(status, count, fill = 0) %>%
  adorn_totals(where = c("row", "col"))

table_validation_overall_past_3_weeks %>%
 show_table()
  
```

## Overall Proportion Validated

```{r sous_co_proportion_validated}

x_prop <- x %>%
  group_by(epiweek_report_label, status) %>%
  summarise(count = n()) %>%
  spread(status, count, fill = 0) %>% 
  mutate(total = invalidee + validee,
         p   = prop_to_perc(validee / total),
         lci = prop_ci(validee, total, "lower", TRUE),
         uci = prop_ci(validee, total, "upper", TRUE)) %>%
  select(epiweek_report_label, p, lci, uci)

ggplot(x_prop, aes(x = epiweek_report_label, col = "#D56F3E")) +
  geom_ribbon(aes(ymin = lci, ymax = uci), alpha = 0.2, colour = NA) +
  geom_point(aes(y = p), size = 2) +
  geom_line(aes(y = p), size = 1) + 
  scale_color_discrete(guide = FALSE) +
  ylim(c(0, 100)) +
  labs(x = "",
       y = "Pourcentage d'alertes validées \npar semaine",
       title = paste0("Proportion d'alertes validées par semaine - Goma")) +
  large_txt +
  rotate_x_text(45) +
  theme(legend.position = "bottom") +
  scale_months

```


## Health Zone 

### Total Since Database Start

``` {r health_zone_total}

x_validations <- x %>%
  group_by(status, top_zones) %>%
  summarise(count = n())

ggplot(x_validations, aes(x = top_zones, y = count, fill = status)) +
  geom_col() +
  scale_x_discrete(drop = FALSE) +
  scale_validations +
  labs(x = "",
       y = "Nombre d'alertes",
       title = "Nombre d'alertes par statut de validation et \nzone de santé") +
  theme(legend.position = "bottom") +
  large_txt +
  rotate_x_text(45)

```

### Table - Total Since Database Start  

```{r health_zone_total_table, fig.keep = "all"}

table_hz_total_validation <- x %>%
  group_by(top_zones, status) %>%
  summarise(count = n()) %>%
  complete(status) %>%
  spread(status, count, fill = 0) %>% 
  adorn_totals(where = c("row", "col"))

table_hz_total_validation %>%
 show_table()
  
```

### Weekly Since Database Start

```{r health_zone_time, fig.width = 12, fig.height = 8}

ggplot(x, aes(x = date, fill = status)) +
  geom_histogram(binwidth = 7, col = "white") +
  facet_wrap( ~ top_zones, scale = "free_y") +
  scale_validations + 
  labs(x = "",
       y = "Nombre d'alertes par semaine",
       title = paste0("Nombre d'alertes par statut de validation ",
                      " et zone de santé - Goma")) +
  large_txt +
  rotate_x_text(45) +
  theme(legend.position = "bottom") +
  scale_months

```

### Table - Weekly Since Database Start

```{r health_zone_time_table, fig.keep = "all"}

table_hz_over_time_validation <- x %>%
  group_by(epiweek_report, top_zones, status) %>%
  summarise(count = n()) %>%
  complete(status, nesting(epiweek_report, top_zones), fill = list(count = 0)) %>%
  spread(status, count, fill = 0) %>%
  adorn_totals(where = c("row", "col"))

table_hz_over_time_validation %>%
 show_table()
  
```


## Health Zone - Past 3 Weeks

### Total Past 3 Weeks

``` {r health_zone_total_recent}

x_validations_recent <- x_recent %>%
  group_by(status, top_zones) %>%
  summarise(count = n())

ggplot(x_validations_recent, aes(x = top_zones, y = count, fill = status)) +
  geom_col() +
  scale_x_discrete(drop = FALSE) +
  scale_validations +
  labs(x = "",
       y = "Nombre d'alertes",
       title = paste("Nombre d'alertes par statut de validation et \nzone de santé",
                     " depuis les 3 semaines dernières")) +
  theme(legend.position = "bottom") +
  large_txt 

```

### Table - Total Past 3 Weeks

```{r health_zone_total_recent_table, fig.keep = "all"}

table_hz_total_recent_validation <- x_recent %>%
  group_by(top_zones, status) %>%
  summarise(count = n()) %>%
  complete(status) %>%
  spread(status, count, fill = 0) %>% 
  adorn_totals(where = c("row", "col"))

table_hz_total_recent_validation %>%
 show_table()
  
```


### Daily Past 3 Weeks 

```{r health_zone_time_recent, fig.width = 12, fig.height = 8}

ggplot(x_recent, aes(x = date, fill = status)) +
  geom_histogram(binwidth = 1, col = "white") +
  facet_wrap( ~ top_zones, scale = "free_y") +
  scale_validations + 
  labs(x = "",
       y = "Nombre d'alertes par jour",
       title = paste0("Nombre d'alertes par statut de validation ",
                      "et zone de sante - Goma")) +
  large_txt +
  rotate_x_text(45) +
  theme(legend.position = "bottom") +
  scale_weeks

```

### Table - Daily Past 3 Weeks 

```{r health_zone_time_recent_table, fig.width = 12, fig.height = 5}

table_hz_over_time_recent_validation <- x_recent %>%
  group_by(date, top_zones, status) %>%
  summarise(count = n()) %>%
  complete(status) %>%
  spread(status, count, fill = 0) %>%
  adorn_totals(where = c("row", "col"))

table_hz_over_time_recent_validation %>%
 show_table()
  
```

## Health Area 

### Total Since Database Start

``` {r health_area_total, fig.width = 14}

x_validations <- x %>%
  group_by(status, zone_de_sante, aire_de_sante) %>%
  summarise(count = n())

x_validations %>% 
  filter(count >= 100) %>% 
  ggplot(aes(x = aire_de_sante, y = count, fill = status)) +
  geom_col() +
  scale_x_discrete(drop = FALSE) +
  scale_validations +
  facet_grid(. ~ zone_de_sante, scales = "free_x", space = "free") +
  theme(strip.text.x = element_text(size = 12, angle = 0, color = "#5c8a8a"),
        strip.background = element_rect(fill = "#e0ebeb", color = "#5c8a8a")) +
  labs(x = "",
       y = "Nombre d'alertes",
       title = "Nombre d'alertes par statut de validation et aire de santé",
       subtitle = "avec plus de 100 alertes") +
  theme(legend.position = "bottom") +
  large_txt +
  rotate_x_text(45)


```

### Table - Total Since Database Start  

```{r health_area_total_table, fig.keep = "all"}

table_ha_total_validation <- x %>%
  group_by(aire_de_sante, status) %>%
  summarise(count = n()) %>%
  complete(status) %>%
  spread(status, count, fill = 0) %>% 
  adorn_totals(where = c("row", "col"))

table_ha_total_validation %>%
 show_table()
  
```

### Weekly Since Database Start

```{r health_area_time, fig.width = 12, fig.height = 8}

x_validations <- x %>%
  group_by(epiweek_report_label, status, top_aires) %>%
  summarise(count = n())

ggplot(x_validations, aes(x = epiweek_report_label, y = count, fill = status)) +
  geom_col() +
  facet_wrap( ~ top_aires) +
  scale_validations + 
  labs(x = "",
       y = "Nombre d'alertes par semaine",
       title = paste0("Nombre d'alertes par statut de validation",
                      " et aire de sante - Goma")) +
  large_txt +
  rotate_x_text(45) +
  theme(legend.position = "bottom") +
  scale_x_date(date_breaks = "2 month", date_labels =  "%b") 

```

### Table - Weekly Since Database Start

```{r health_area_time_table_validation_status, fig.keep = "all"}

table_ha_over_time_validation <- x %>%
  group_by(epiweek_report, top_aires, status) %>%
  summarise(count = n()) %>%
  complete(status) %>%
  spread(status, count, fill = 0) %>%
  adorn_totals(where = c("row", "col"))

table_ha_over_time_validation %>%
 show_table()
  
```



## Health Area - Past 3 Weeks

### Total Past 3 Weeks

``` {r health_area_total_recent, fig.width = 14}

x_validations <- x %>%
  filter(date > database_date - 21) %>%
  group_by(status, zone_de_sante, aire_de_sante) %>%
  summarise(count = n()) 

x_validations %>% 
  filter(count >= 20) %>% 
  ggplot(aes(x = aire_de_sante, y = count, fill = status)) +
  geom_col() +
  scale_x_discrete(drop = FALSE) +
  scale_validations +
  facet_grid(. ~ zone_de_sante, scales = "free_x", space = "free") +
  theme(strip.text.x = element_text(size = 12, angle = 0, color = "#5c8a8a"),
        strip.background = element_rect(fill = "#e0ebeb", color = "#5c8a8a")) +
  labs(x = "",
       y = "Nombre d'alertes",
       title = paste("Nombre d'alertes par statut de validation et aire de santé",
                     " depuis les 3 semaines dernières"),
        subtitle = "avec plus de 20 alertes") +
  theme(legend.position = "bottom") +
  large_txt +
  rotate_x_text(45)


```


### Table - Total Past 3 Weeks 

```{r health_area_total_recent_table, fig.keep = "all"}

table_ha_total_recent_validation <- x %>%
  filter(date > database_date - 21) %>%
  group_by(aire_de_sante, status) %>%
  summarise(count = n()) %>%
  complete(status) %>%
  spread(status, count, fill = 0) %>% 
  adorn_totals(where = c("row", "col"))

table_ha_total_recent_validation %>%
 show_table()
  
```

### Daily, Past 3 Weeks

```{r health_area_time_recent, fig.width = 12, fig.height = 8}

x_validations <- x %>%
  filter(date > database_date - 21) %>%
  filter(top_aires != "other") %>%
  group_by(date, status, top_aires) %>%
  summarise(count = n())

ggplot(x_validations, aes(x = date, y = count, fill = status)) +
  geom_col() +
  facet_wrap( ~ top_aires) +
  scale_validations + 
  labs(x = "",
       y = "Nombre d'alertes par jour",
       title = paste0("Nombre d'alertes par statut de validation",
                      " et aire de sante - Goma")) +
  large_txt +
  rotate_x_text(45) +
  theme(legend.position = "bottom") +
  scale_x_date(date_breaks = "1 week", date_labels =  "%d %b") 
  
```


### Table - Daily Past 3 Weeks

```{r health_area_time_recent_table, fig.width = 12, fig.height = 5}

table_ha_over_time_recent_validation <- x %>%
  filter(date > database_date - 21) %>%
  group_by(date, top_aires, status) %>%
  summarise(count = n()) %>%
  complete(status) %>%
  spread(status, count, fill = 0) %>%
  adorn_totals(where = c("row", "col"))

table_ha_over_time_recent_validation %>%
 show_table()
  
```



# Origins {.tabset .tabset-fade .tabset-pills}

## Outline

This section summarises alerts over time according to their origin 

**Note: The Top 3 Health Zones and all Valid Aire de Santes that have reported**
**alerts at any point are plotted when considering totals by geographical area**
**(aggregated over time). The Top 3 Health Zones and the Top 14 Aire de Santes**
**are plotted when it comes to plotting over time (due to space constraints).**


## Overall

### Weekly, Since Database Start

```{r sous_coord_origins}

x_origins <- x %>%
  group_by(epiweek_report_label, origin) %>%
  summarise(count = n())

ggplot(x_origins, aes(x = epiweek_report_label, y = count, fill = origin)) +
  geom_col() +
  scale_x_discrete(drop = FALSE) +
  scale_origins +
  guides(fill = guide_legend(ncol = 2)) +
  labs(x = "",
       y = "Nombre d'alertes par semaine",
       title = "Nombre d'alertes par origine et par semaine") +
  theme(legend.position = "bottom") +
  large_txt +
  rotate_x_text(45) +
  scale_months

```

### Table - Weekly Since Database Start

```{r sous_coord_time_table_origins, fig.keep = "all"}

table_origins <- x %>%
  group_by(epiweek_report, origin) %>%
  summarise(count = n()) %>%
  complete(origin) %>%
  spread(origin, count, fill = 0) %>%
  adorn_totals(where = c("row", "col"))

table_origins %>%
 show_table()
  
```

## Overall Past 3 Weeks

### Daily, Past 3 Weeks

```{r origins_time_recent}

x_recent_origins <- x_recent 

ggplot(x_recent_origins, aes(x = date, fill = origin)) +
  geom_histogram(binwidth = 1, col = "white") +
  theme(strip.text.y = element_text(size = 12, angle = 0)) +
  scale_months +
  scale_origins +
  guides(fill = guide_legend(ncol = 2)) +
  rotate_x_text(45) +
  large_txt +
  theme(legend.position = "bottom",
        panel.spacing.y = unit(1, "lines")) +
  labs(title = "Nombre d'alertes par origine et par semaine",
       x = "",
       y = "Nombre d'alertes par jour") +
  scale_weeks

```

### Table - Daily Past 3 Weeks

```{r sous_coord_time_table_origins_alerts_recent, fig.keep = "all"}

table_origins_recent <- x_recent %>%
  group_by(date, origin) %>%
  summarise(count = n()) %>%
  complete(origin) %>%
  spread(origin, count, fill = 0) %>%
  adorn_totals(where = c("row", "col"))

table_origins_recent %>%
 show_table()
  
```

## Health Zone 

### Total Since Database Start

``` {r health_zone_total_origin}

x_origins <- x %>%
  group_by(origin, top_zones) %>%
  summarise(count = n())

ggplot(x_origins, aes(x = top_zones, y = count, fill = origin)) +
  geom_col() +
  scale_x_discrete(drop = FALSE) +
  scale_origins +
  guides(fill = guide_legend(ncol = 2)) +
  labs(x = "",
       y = "Nombre d'alertes",
       title = "Nombre d'alertes par origine et zone de santé") +
  theme(legend.position = "bottom") +
  large_txt +
  rotate_x_text(45)

```

### Table - Total Since Database Start  

```{r health_zone_total_table_origin, fig.keep = "all"}

table_hz_total_origins <- x %>%
  group_by(top_zones, origin) %>%
  summarise(count = n()) %>%
  complete(origin) %>%
  spread(origin, count, fill = 0) %>% 
  adorn_totals(where = c("row", "col"))

table_hz_total_origins %>%
 show_table()
  
```

### Weekly Since Database Start

```{r health_zone_time_origin, fig.width = 12, fig.height = 8}

ggplot(x, aes(x = date, fill = origin)) +
  geom_histogram(binwidth = 7, col = "white") +
  facet_wrap( ~ top_zones, scale = "free_y") +
  scale_origins + 
  labs(x = "",
       y = "Nombre d'alertes par semaine",
       title = paste0("Nombre d'alertes par origin de validation ",
                      "et zone de santé - Goma")) +
  large_txt +
  rotate_x_text(45) +
  theme(legend.position = "bottom") +
  scale_months

```

### Table - Weekly Since Database Start

```{r health_zone_time_table_origin, fig.keep = "all"}

table_hz_over_time_origins <- x %>%
  group_by(epiweek_report, top_zones, origin) %>%
  summarise(count = n()) %>%
  complete(origin) %>%
  spread(origin, count, fill = 0) %>%
  adorn_totals(where = c("row", "col"))

table_hz_over_time_origins %>%
 show_table()
  
```

## Health Zone - Past 3 Weeks

### Total Past 3 Weeks

``` {r health_zone_total_recent_origin_recent}

x_origins_recent <- x_recent %>%
  group_by(origin, top_zones) %>%
  summarise(count = n())

ggplot(x_origins_recent, aes(x = top_zones, y = count, fill = origin)) +
  geom_col() +
  scale_x_discrete(drop = FALSE) +
  scale_origins +
  guides(fill = guide_legend(ncol = 2)) +
  labs(x = "",
       y = "Nombre d'alertes",
       title = paste("Nombre d'alertes par origine et zone de santé depuis\n", 
                     "les 3 semaines dernières")) +
  theme(legend.position = "bottom") +
  large_txt 

```

### Table - Total Past 3 Weeks

```{r health_zone_total_recent_table_origins, fig.keep = "all"}

table_hz_total_recent_origins <- x_recent %>%
  group_by(top_zones, origin) %>%
  summarise(count = n()) %>%
  complete(origin) %>%
  spread(origin, count, fill = 0) %>% 
  adorn_totals(where = c("row", "col"))

table_hz_total_recent_origins %>%
 show_table()
  
```


### Daily Past 3 Weeks 

```{r health_zone_time_recent_origins, fig.width = 12, fig.height = 8}

ggplot(x_recent, aes(x = date, fill = origin)) +
  geom_histogram(binwidth = 1, col = "white") +
  facet_wrap( ~ top_zones, scale = "free_y") +
  scale_origins + 
  labs(x = "",
       y = "Nombre d'alertes par jour",
       title = paste0("Nombre d'alertes par origine de validation ",
                      "et zone de sante - Goma")) +
  large_txt +
  rotate_x_text(45) +
  theme(legend.position = "bottom") +
  scale_weeks 

```

### Table - Daily Past 3 Weeks 

```{r health_zone_time_recent_table_origins, fig.width = 12, fig.height = 5}

table_hz_over_time_recent_origins <- x_recent %>%
  group_by(date, top_zones, origin) %>%
  summarise(count = n()) %>%
  complete(origin) %>%
  spread(origin, count, fill = 0) %>%
  adorn_totals(where = c("row", "col"))

table_hz_over_time_recent_origins %>%
 show_table()
  
```

## Health Area 

### Total Since Database Start

``` {r health_area_total_origins, fig.width = 14}

x_origins <- x %>%
  group_by(origin, zone_de_sante, aire_de_sante) %>%
  summarise(count = n()) 

x_origins %>% 
  filter(count >= 100) %>% 
  ggplot(aes(x = aire_de_sante, y = count, fill = origin)) +
  geom_col() +
  scale_x_discrete(drop = FALSE) +
  scale_origins +
  facet_grid(. ~ zone_de_sante, scales = "free_x", space = "free") +
  theme(strip.text.x = element_text(size = 12, angle = 0, color = "#5c8a8a"),
        strip.background = element_rect(fill = "#e0ebeb", color = "#5c8a8a")) +
  labs(x = "",
       y = "Nombre d'alertes",
       title = "Nombre d'alertes par statut de validation et aire de santé",
       subtitle = "avec plus de 100 alertes") +
  theme(legend.position = "bottom") +
  large_txt +
  rotate_x_text(45)


```

### Table - Total Since Database Start  


```{r health_area_total_table_origins, fig.keep = "all"}

table_ha_total_origins <- x %>%
  group_by(aire_de_sante, origin) %>%
  summarise(count = n()) %>%
  complete(origin) %>%
  spread(origin, count, fill = 0) %>% 
  adorn_totals(where = c("row", "col"))

table_ha_total_origins %>%
 show_table()
  
```

### Weekly Since Database Start

```{r health_area_time_origin, fig.width = 12, fig.height = 8}

x_origins <- x %>%
  filter(top_aires != "other") %>%
  group_by(epiweek_report_label, origin, top_aires) %>%
  summarise(count = n())

ggplot(x_origins, aes(x = epiweek_report_label, y = count, fill = origin)) +
  geom_col() +
  facet_wrap( ~ top_aires) +
  scale_origins + 
  labs(x = "",
       y = "Nombre d'alertes par semaine",
       title = paste0("Nombre d'alertes par statut de validation",
                      " et zone de sante - Goma")) +
  large_txt +
  rotate_x_text(45) +
  theme(legend.position = "bottom") +
  scale_x_date(date_breaks = "2 month", date_labels =  "%b") 

```

### Table - Weekly Since Database Start

```{r health_area_time_table_origin, fig.keep = "all"}

table_ha_over_time_origins <- x %>%
  group_by(epiweek_report, top_aires, origin) %>%
  summarise(count = n()) %>%
  complete(origin) %>%
  spread(origin, count, fill = 0) %>%
  adorn_totals(where = c("row", "col"))

table_ha_over_time_origins %>%
 show_table()
  
```


## Health Area - Past 3 Weeks

### Total Past 3 Weeks

``` {r health_area_total_recent_origin, fig.width = 14}

x_origins <- x %>%
  filter(date > database_date - 21) %>%
  group_by(origin, zone_de_sante, aire_de_sante) %>%
  summarise(count = n()) 

x_origins %>% 
  filter(count >= 20) %>% 
  ggplot(aes(x = aire_de_sante, y = count, fill = origin)) +
  geom_col() +
  scale_x_discrete(drop = FALSE) +
  scale_origins +
  facet_grid(. ~ zone_de_sante, scales = "free_x", space = "free") +
  theme(strip.text.x = element_text(size = 12, angle = 0, color = "#5c8a8a"),
        strip.background = element_rect(fill = "#e0ebeb", color = "#5c8a8a")) +
  labs(x = "",
       y = "Nombre d'alertes",
       title = paste("Nombre d'alertes par statut de validation et aire de santé",
                     "\ndepuis les 3 semaines dernières"),
       subtitle = "avec plus de 20 alertes") +
  theme(legend.position = "bottom") +
  large_txt +
  rotate_x_text(45)


```


### Table - Total Past 3 Weeks 

```{r health_area_total_recent_table_origin, fig.keep = "all"}

table_ha_total_recent_origins <- x %>%
  group_by(aire_de_sante, origin) %>%
  summarise(count = n()) %>%
  complete(origin) %>%
  spread(origin, count, fill = 0) %>% 
  adorn_totals(where = c("row", "col"))

table_ha_total_recent_origins %>%
 show_table()
  
```

### Daily, Past 3 Weeks

```{r health_area_time_recent_origin_recent, fig.width = 12, fig.height = 8}

x_origins_recent <- x %>%
  filter(top_aires != "other") %>%
  filter(date > database_date - 21) %>%
  group_by(date, origin, top_aires) %>%
  summarise(count = n())

ggplot(x_origins_recent, aes(x = date, y = count, fill = origin)) +
  geom_col() +
  facet_wrap( ~ top_aires) +
  scale_origins + 
  labs(x = "",
       y = "Nombre d'alertes par jour",
       title = paste0("Nombre d'alertes par statut de validation",
                      " et aire de santé - Goma")) +
  large_txt +
  rotate_x_text(45) +
  theme(legend.position = "bottom") +
  scale_x_date(date_breaks = "1 week", date_labels =  "%d %b") 
  
```


### Table - Daily Past 3 Weeks

```{r health_area_time_recent_table_origin, fig.width = 12, fig.height = 5}

table_ha_over_time_recent_origins <- x %>%
  filter(date > database_date - 21) %>%
  group_by(date, top_aires, origin) %>%
  summarise(count = n()) %>%
  complete(origin) %>%
  spread(origin, count, fill = 0) %>%
  adorn_totals(where = c("row", "col"))

table_ha_over_time_recent_origins %>%
 show_table()
  
```


# Validation decisions {.tabset .tabset-fade .tabset-pills}

## Outline

This section focuses on the decision of alerts, by health zones.

When looking at decisions on the treatment of alerts, we identify the 4
following situations:

* **<font color = "#94b8b8">true positive</font>**: alerts were rightfully
  validated (patient tested)
* **<font color = "#8c8cd9">true negative</font>**: alerts were rightfully not
  validated (patient not tested)
* **<font color = "#ff8080">false positive</font>**: alerts were wrongly
  validated (patient tested, shoud not have been)
* **<font color = "#b3003b">false negative</font>**: alerts were wrongly not
  validated (patient not tested, should have been)

**False positive** create a waste of resources as well as un-necessary pressure
on the patient and community. **False negative** create a risk of missing cases.

**Note: The Top 3 Health Zones and all Valid Aire de Santes that have reported**
**alerts at any point are plotted when considering totals by geographical area**
**(aggregated over time). The Top 3 Health Zones and the Top 14 Aire de Santes**
**are plotted when it comes to plotting over time (due to space constraints).**

## Overall

### Weekly, Since Database Start

```{r decisions}

ggplot(outcomes, aes(x = epiweek_report_label, fill = decision_comparison)) +
  geom_bar(color = "white") +
  scale_x_discrete(drop = FALSE) +
  labs(x = "",
       y = "Nombre d'alertes",
       title = "Nombre d'alertes par décision de validation") +
  theme(legend.position = "bottom") +
  large_txt +
  scale_decisions +
  rotate_x_text(45) +
  scale_months

```

### Table - Weekly Since Database Start 

``` {r table_decisions}

table_decisions <- outcomes %>%
  group_by(epiweek_report, decision_comparison) %>%
  summarise(count = n()) %>%
  spread(decision_comparison, count, fill = 0) %>% 
  adorn_totals(c("row", "col")) %>%
  mutate(prop_false_positive_95ci =   
           prop_to_display_ci(false_positive, Total, dec = 2, perc = TRUE),
         prop_false_negative_95ci = 
           prop_to_display_ci(false_negative, Total, dec = 2, perc = TRUE),
         prop_false_positive = prop_to_perc(false_positive / Total),
         lower_false_positive = prop_ci(false_positive, Total, "lower", TRUE),
         upper_false_positive = prop_ci(false_positive, Total, "upper", TRUE),
         prop_false_negative = prop_to_perc(false_negative / Total),
         lower_false_negative = prop_ci(false_negative, Total, "lower", TRUE),
         upper_false_negative = prop_ci(false_negative, Total, "upper", TRUE))

table_decisions %>%
    select(-prop_false_positive,
          -lower_false_positive,
          -upper_false_positive,
          -prop_false_negative ,
          -lower_false_negative,
          -upper_false_negative
         ) %>% 
  show_table()

```


### Table - Incorrectly Validated/Not Validated

* Individuals incorrectly validated. They were validated and tested but did not meet the case definition.
* Individuals incorrectly not validated. They were not validated and tested but did meet the case definition.

```{r sens_spec}

table_sens_spec <- outcomes %>%
  group_by(top_zones, decision_comparison) %>%
  summarise(count = n()) %>%
  spread(decision_comparison, count, fill = 0) %>% 
  mutate(total_tested = true_positive + false_positive,
         total_not_tested = true_negative + false_negative) %>% 
  mutate(incorrectly_validated_95ci = 
           prop_to_display_ci(false_positive, total_tested, 
                              dec = 2, perc = TRUE),
         incorrectly_not_validated_95ci = 
           prop_to_display_ci(false_negative, total_not_tested, 
                              dec = 2, perc = TRUE))
table_sens_spec %>% 
  show_table()

```

`incorrectly validated` refers to the proportion of validated alerts which should not have been validated. `incorrectly invalidated` refers to the proportion of invalidated alerts that should have been validated.  

**Note:** The `incorrectly validated` variable will be over-estimated if alerts forms are poorly documented/incomplete - i.e. if patients had symptoms not reported in the form but that were used in the decision making process. 


## Overall Past 3 Weeks

### Daily, Past 3 Weeks

```{r decisions_time}

ggplot(outcomes_recent, aes(x = date, fill = decision_comparison)) +
  geom_histogram(binwidth = 1, col = "white") +
  theme(strip.text.y = element_text(size = 12, angle = 0)) +
  scale_months +
  rotate_x_text(45) +
  large_txt +
  scale_decisions +
  theme(legend.position = "bottom") +
  labs(title = paste("Nombre d'alertes par décision de validation"),
       x = "",
       y = "Nombre d'alertes par jour") +
  scale_weeks

```

### Over Time Table

``` {r decisions_over_time}

table_decisions_recent <- incidence(
  outcomes_recent$date, "day", 
  groups = outcomes_recent$decision_comparison) %>%
  as.data.frame() %>%
  adorn_totals(where = c("row", "col"))

table_decisions_recent %>%
  show_table()

```


## Health Zone 

### Total Since Database Start

``` {r health_zone_total_decision}

x_decisions <- outcomes %>%
  group_by(decision_comparison, top_zones) %>%
  summarise(count = n())

ggplot(x_decisions, aes(x = top_zones, y = count, fill = decision_comparison)) +
  geom_col() +
  scale_x_discrete(drop = FALSE) +
  scale_decisions +
  labs(x = "",
       y = "Nombre d'alertes",
       title = "Nombre d'alertes par décision et zone de santé") +
  theme(legend.position = "bottom") +
  large_txt +
  rotate_x_text(45)

```

### Table - Total Since Database Start  

```{r health_zone_total_table_decision, fig.keep = "all"}

table_hz_total_decisions <- outcomes %>%
  group_by(top_zones, decision_comparison) %>%
  summarise(count = n()) %>%
  complete(decision_comparison) %>%
  spread(decision_comparison, count, fill = 0) %>% 
  adorn_totals(where = c("row", "col"))

table_hz_total_decisions %>%
 show_table()
  
```

### Weekly Since Database Start

```{r health_zone_time_decision, fig.width = 12, fig.height = 8}

ggplot(outcomes, aes(x = date, fill = decision_comparison)) +
  geom_histogram(binwidth = 7, col = "white") +
  facet_wrap( ~ top_zones, scale = "free_y") +
  scale_decisions + 
  labs(x = "",
       y = "Nombre d'alertes par semaine",
       title = paste0("Nombre d'alertes par décision de validation ",
                      "et zone de santé - Goma")) +
  large_txt +
  rotate_x_text(45) +
  theme(legend.position = "bottom") +
  scale_months

```

### Table - Weekly Since Database Start

```{r health_zone_time_table_decision, fig.keep = "all"}

table_hz_over_time_decisions <- outcomes %>%
  group_by(epiweek_report, top_zones, decision_comparison) %>%
  summarise(count = n()) %>%
  complete(decision_comparison) %>%
  spread(decision_comparison, count, fill = 0) %>%
  adorn_totals(where = c("row", "col"))

table_hz_over_time_decisions %>%
 show_table()
  
```

## Health Zone - Past 3 Weeks

### Total Past 3 Weeks

``` {r health_zone_total_recent_decision_recent}

x_decisions_recent <- outcomes_recent %>%
  group_by(decision_comparison, top_zones) %>%
  summarise(count = n())

ggplot(x_decisions_recent, 
       aes(x = top_zones, y = count, fill = decision_comparison)) +
  geom_col() +
  scale_x_discrete(drop = FALSE) +
  scale_decisions +
  labs(x = "",
       y = "Nombre d'alertes",
       title = paste("Nombre d'alertes par décision et zone de santé depuis",
                     "\nles 3 semaines dernières")) +
  theme(legend.position = "bottom") +
  large_txt

```

### Table - Total Past 3 Weeks

```{r health_zone_total_recent_table_decisions, fig.keep = "all"}

table_hz_total_recent_decisions <- outcomes_recent %>%
  group_by(top_zones, decision_comparison) %>%
  summarise(count = n()) %>%
  complete(decision_comparison) %>%
  spread(decision_comparison, count, fill = 0) %>% 
  adorn_totals(where = c("row", "col"))

table_hz_total_recent_decisions %>%
 show_table()
  
```

### Daily Past 3 Weeks 

```{r health_zone_time_recent_decisions, fig.width = 12, fig.height = 8}

ggplot(outcomes_recent, aes(x = date, fill = decision_comparison)) +
  geom_histogram(binwidth = 1, col = "white") +
  facet_wrap( ~ top_zones, scale = "free_y") +
  scale_decisions + 
  labs(x = "",
       y = "Nombre d'alertes par jour",
       title = paste0("Nombre d'alertes par décision de validation ",
                      "et zone de sante - Goma")) +
  large_txt +
  rotate_x_text(45) +
  theme(legend.position = "bottom") +
  scale_weeks 

```

### Table - Daily Past 3 Weeks 

```{r health_zone_time_recent_table_decisions, fig.width = 12, fig.height = 5}

table_hz_over_time_recent_decisions <- outcomes_recent %>%
  group_by(date, top_zones, decision_comparison) %>%
  summarise(count = n()) %>%
  complete(decision_comparison) %>%
  spread(decision_comparison, count, fill = 0) %>%
  adorn_totals(where = c("row", "col"))

table_hz_over_time_recent_decisions %>%
 show_table()
  
```


## Health Area 

### Total Since Database Start

``` {r health_area_total_decisions, fig.width = 14}

x_decisions <- outcomes %>%
  group_by(decision_comparison, zone_de_sante, aire_de_sante) %>%
  summarise(count = n()) 

x_decisions %>% 
  filter(count >= 100) %>% 
ggplot(aes(x = aire_de_sante, y = count, fill = decision_comparison)) +
  geom_col() +
  scale_x_discrete(drop = FALSE) +
  scale_decisions +
  facet_grid(. ~ zone_de_sante, scales = "free_x", space = "free") +
  theme(strip.text.x = element_text(size = 12, angle = 0, color = "#5c8a8a"),
        strip.background = element_rect(fill = "#e0ebeb", color = "#5c8a8a")) +
  labs(x = "",
       y = "Nombre d'alertes",
       title = "Nombre d'alertes par décision de validation et aire de santé",
       subtitle = "avec plus de 100 alertes") +
  theme(legend.position = "bottom") +
  large_txt +
  rotate_x_text(45)


```

### Table - Total Since Database Start  


```{r health_area_total_table_decisions, fig.keep = "all"}

table_ha_total_decision <- outcomes %>%
  group_by(aire_de_sante, decision_comparison) %>%
  summarise(count = n()) %>%
  complete(decision_comparison) %>%
  spread(decision_comparison, count, fill = 0) %>% 
  adorn_totals(where = c("row", "col"))

table_ha_total_decision %>%
 show_table()
  
```

### Weekly Since Database Start

```{r health_area_time_decision, fig.width = 12, fig.height = 8}

x_decisions <- outcomes %>%
  filter(top_aires != "other") %>%
  group_by(epiweek_report_label, decision_comparison, top_aires) %>%
  summarise(count = n())


ggplot(x_decisions, aes(x = epiweek_report_label, y = count, 
                        fill = decision_comparison)) +
  geom_col() +
  facet_wrap( ~ top_aires) +
  scale_decisions + 
  labs(x = "",
       y = "Nombre d'alertes par semaine",
       title = paste0("Nombre d'alertes par décision de validation",
                      " et aire de sante - Goma")) +
  large_txt +
  rotate_x_text(45) +
  theme(legend.position = "bottom") +
  scale_x_date(date_breaks = "2 month", date_labels =  "%b") 

```

### Table - Weekly Since Database Start

```{r health_area_time_table_decision, fig.keep = "all"}

table_ha_over_time_decisions <- outcomes %>%
  group_by(epiweek_report, top_aires, decision_comparison) %>%
  summarise(count = n()) %>%
  complete(decision_comparison) %>%
  spread(decision_comparison, count, fill = 0) %>%
  adorn_totals(where = c("row", "col"))

table_ha_over_time_decisions %>%
 show_table()
  
```


## Health Area - Past 3 Weeks

### Total Past 3 Weeks

``` {r health_area_total_recent_decision, fig.width = 14}

x_decisions <- outcomes %>%
  filter(date > database_date - 21) %>%
  group_by(decision_comparison, zone_de_sante, aire_de_sante) %>%
  summarise(count = n()) 

x_decisions %>% 
  filter(count >= 20) %>% 
ggplot(aes(x = aire_de_sante, y = count, fill = decision_comparison)) +
  geom_col() +
  scale_x_discrete(drop = FALSE) +
  scale_decisions +
  facet_grid(. ~ zone_de_sante, scales = "free_x", space = "free") +
  theme(strip.text.x = element_text(size = 12, angle = 0, color = "#5c8a8a"),
        strip.background = element_rect(fill = "#e0ebeb", color = "#5c8a8a")) +
  labs(x = "",
       y = "Nombre d'alertes",
       title = paste("Nombre d'alertes par décision de validation et aire de santé",
                     "\ndepuis les 3 semaines dernières"),
       subtitle = "avec plus de 20 alertes") +
  theme(legend.position = "bottom") +
  large_txt +
  rotate_x_text(45)


```


### Table - Total Past 3 Weeks 

```{r health_area_total_recent_table_decision, fig.keep = "all"}

table_ha_total_recent_decisions <- outcomes %>%
  group_by(aire_de_sante, decision_comparison) %>%
  summarise(count = n()) %>%
  complete(decision_comparison) %>%
  spread(decision_comparison, count, fill = 0) %>% 
  adorn_totals(where = c("row", "col"))

table_ha_total_recent_decisions %>%
 show_table()
  
```

### Daily, Past 3 Weeks

```{r health_area_time_recent_decision_recent, fig.width = 12, fig.height = 8}

x_decisions_recent <- outcomes %>%
  filter(top_aires != "other") %>%
  filter(date > database_date - 21) %>%
  group_by(date, decision_comparison, top_aires) %>%
  summarise(count = n())

ggplot(x_decisions_recent, aes(x = date, y = count, fill = decision_comparison)) +
  geom_col() +
  facet_wrap( ~ top_aires) +
  scale_decisions + 
  labs(x = "",
       y = "Nombre d'alertes par jour",
       title = paste0("Nombre d'alertes par décision de validation",
                      " et aire de santé - Goma")) +
  large_txt +
  rotate_x_text(45) +
  theme(legend.position = "bottom") +
  scale_x_date(date_breaks = "1 week", date_labels =  "%d %b") 
  
```


### Table - Daily Past 3 Weeks

```{r health_area_time_recent_table_decision}

table_ha_over_time_recent_decisions <- outcomes %>%
  filter(date > database_date - 21) %>%
  group_by(date, top_aires, decision_comparison) %>%
  summarise(count = n()) %>%
  complete(decision_comparison) %>%
  spread(decision_comparison, count, fill = 0) %>%
  adorn_totals(where = c("row", "col"))

table_ha_over_time_recent_decisions %>%
 show_table()
  
```




# Export data and tables  {.tabset .tabset-fade .tabset-pills}


```{r reactivate_recent, include = FALSE}
knitr::opts_chunk$set(eval = TRUE)
```

## Outline

We export the clean data to the clean data folder and some of the relevant tables, which will be placed in the current
working directory.

## R objects

We export some of the clean database, placed in `produced_rds/` as well as in
`data/clean/`:

```{r export_rds, eval = TRUE}

## check if a directory exists and if not then creates it
if (!dir.exists("produced_rds")) {
  dir.create("produced_rds")
}

## create the text for the file name with the database date
rds_file_name <- sprintf("%sclean_%s.rds",
                     undated_file_name(current_goma),
                     format(database_date, "%Y-%m-%d"))
rds_file_name

## save the rds file in the produced_rds folder
rio::export(x,
            file.path("produced_rds", rds_file_name))

```

We copy these files to the `data/clean` folder:

```{r copy_rds, eval = TRUE}
# copy some files into `data/clean/`

# Provide the destination of where to copy the data
destination <- here::here("data",
                    "clean",
                    rds_file_name)
# Copy the rds data
file.copy(from = file.path("produced_rds", rds_file_name),
          to = destination,
          overwrite = TRUE)

```


## Excel files

```{r exports, eval = TRUE}

if (!dir.exists("produced_xlsx")) {
  dir.create("produced_xlsx")
}

```

### Cleaned Alerts Database

``` {r exports_cleaned_alerts}

## Cleaned Alerts Database
rio::export(x, 
            file.path("produced_xlsx", "cleaned_alerts_database_goma.xlsx"))

```

### Validation Status 

``` {r exports_validation}

## Validation Status

### since database start over time sous coordination
table_validation_file_name <- sprintf("%stable_validation.xlsx",
                                        undated_file_name(current_goma))
rio::export(table_validation_overall_time,
            file.path("produced_xlsx", table_validation_file_name))

### past 3 weeks over time sous coordination
table_validation_recent_file_name <- sprintf("%stable_validation_recent.xlsx",
                                               undated_file_name(current_goma))
rio::export(table_validation_overall_past_3_weeks,
            file.path("produced_xlsx", table_validation_recent_file_name))

### since database start by health zone total
table_hz_total_validation_file_name <- sprintf("%stable_hz_validation_total.xlsx",
                                    undated_file_name(current_goma))
rio::export(table_hz_total_validation,
            file.path("produced_xlsx", table_hz_total_validation_file_name))

### since database start by health zone over time
table_hz_over_time_validation_file_name <- sprintf("%stable_hz_validation_over_time.xlsx",
                                           undated_file_name(current_goma))
rio::export(table_hz_over_time_validation,
            file.path("produced_xlsx", table_hz_over_time_validation_file_name))

### past 3 weeks by health zone total
table_hz_total_recent_validation_file_name <- sprintf("%stable_hz_validation_total_recent.xlsx",
                                        undated_file_name(current_goma))
rio::export(table_hz_total_recent_validation,
            file.path("produced_xlsx", table_hz_total_recent_validation_file_name))

### past 3 weeks by health zone over time 
table_hz_over_time_recent_validation_file_name <- sprintf("%stable_hz_validation_over_time_recent.xlsx",
                                               undated_file_name(current_goma))
rio::export(table_hz_over_time_recent_validation,
            file.path("produced_xlsx", table_hz_over_time_recent_validation_file_name))

### since database start by health area total
table_ha_total_validation_file_name <- sprintf("%stable_ha_validation_total.xlsx",
                                               undated_file_name(current_goma))
rio::export(table_ha_total_validation_file_name,
            file.path("produced_xlsx", table_ha_total_validation_file_name))

### since database start by health area over time
table_ha_over_time_validation_file_name <- sprintf("%stable_ha_validation_over_time.xlsx",
                                               undated_file_name(current_goma))
rio::export(table_ha_over_time_validation,
            file.path("produced_xlsx", table_ha_over_time_validation_file_name))

### past 3 weeks by health area total
table_ha_total_recent_validation_file_name <- sprintf("%stable_ha_validation_total_recent.xlsx",
                                               undated_file_name(current_goma))
rio::export(table_ha_total_recent_validation,
            file.path("produced_xlsx", table_ha_total_recent_validation_file_name))

### past 3 weeks by health area over time
table_ha_over_time_recent_validation_file_name <- sprintf("%stable_ha_validation_over_time_recent.xlsx",
                                               undated_file_name(current_goma))
rio::export(table_ha_over_time_recent_validation,
            file.path("produced_xlsx", table_ha_over_time_recent_validation_file_name))


```

### Alert Origins

``` {r exports_origins}

## Origins

### since database start over time sous coordination
table_origins_file_name <- sprintf("%stable_origins.xlsx",
                                        undated_file_name(current_goma))
rio::export(table_origins,
            file.path("produced_xlsx", table_origins_file_name))

### past 3 weeks over time sous coordination
table_origins_recent_file_name <- sprintf("%stable_origins_recent.xlsx",
                                               undated_file_name(current_goma))
rio::export(table_origins_recent,
            file.path("produced_xlsx", table_origins_recent_file_name))

### since database start by health zone total
table_hz_total_origins_file_name <- sprintf("%stable_hz_origins_total.xlsx",
                                    undated_file_name(current_goma))
rio::export(table_hz_total_origins,
            file.path("produced_xlsx", table_hz_total_origins_file_name))

### since database start by health zone over time
table_hz_over_time_origins_file_name <- sprintf("%stable_hz_origins_over_time.xlsx",
                                           undated_file_name(current_goma))
rio::export(table_hz_over_time_origins,
            file.path("produced_xlsx", table_hz_over_time_origins_file_name))

### past 3 weeks by health zone total
table_hz_total_recent_origins_file_name <- sprintf("%stable_hz_origins_total_recent.xlsx",
                                        undated_file_name(current_goma))
rio::export(table_hz_total_recent_origins,
            file.path("produced_xlsx", table_hz_total_recent_origins_file_name))

### past 3 weeks by health zone over time 
table_hz_over_time_recent_origins_file_name <- sprintf("%stable_hz_origins_over_time_recent.xlsx",
                                               undated_file_name(current_goma))
rio::export(table_hz_over_time_recent_origins,
            file.path("produced_xlsx", table_hz_over_time_recent_origins_file_name))

### since database start by health area total
table_ha_total_origins_file_name <- sprintf("%stable_ha_origins_total.xlsx",
                                               undated_file_name(current_goma))
rio::export(table_ha_total_origins_file_name,
            file.path("produced_xlsx", table_ha_total_origins_file_name))

### since database start by health area over time
table_ha_over_time_origins_file_name <- sprintf("%stable_ha_origins_over_time.xlsx",
                                               undated_file_name(current_goma))
rio::export(table_ha_over_time_origins,
            file.path("produced_xlsx", table_ha_over_time_origins_file_name))

### past 3 weeks by health area total
table_ha_total_recent_origins_file_name <- sprintf("%stable_ha_origins_total_recent.xlsx",
                                               undated_file_name(current_goma))
rio::export(table_ha_total_recent_origins,
            file.path("produced_xlsx", table_ha_total_recent_origins_file_name))

### past 3 weeks by health area over time
table_ha_over_time_recent_origins_file_name <- sprintf("%stable_ha_origins_over_time_recent.xlsx",
                                               undated_file_name(current_goma))
rio::export(table_ha_over_time_recent_origins,
            file.path("produced_xlsx", table_ha_over_time_recent_origins_file_name))

```


### Validation Decision

``` {r exports_validation_decision}

## Validation Decision

### since database start over time sous coordination
table_decisions_file_name <- sprintf("%stable_decisions.xlsx",
                                        undated_file_name(current_goma))
rio::export(table_decisions,
            file.path("produced_xlsx", table_decisions_file_name))

### since database start over time sous coordination
table_sens_spec_file_name <- sprintf("%stable_sens_spec.xlsx",
                                        undated_file_name(current_goma))
rio::export(table_sens_spec,
            file.path("produced_xlsx", table_sens_spec_file_name))

### past 3 weeks over time sous coordination
table_decisions_recent_file_name <- sprintf("%stable_decisions_recent.xlsx",
                                               undated_file_name(current_goma))
rio::export(table_decisions_recent,
            file.path("produced_xlsx", table_decisions_recent_file_name))

### since database start by health zone total
table_hz_total_decisions_file_name <- sprintf("%stable_hz_decisions_total.xlsx",
                                    undated_file_name(current_goma))
rio::export(table_hz_total_decisions,
            file.path("produced_xlsx", table_hz_total_decisions_file_name))

### since database start by health zone over time
table_hz_over_time_decisions_file_name <- sprintf("%stable_hz_decisions_over_time.xlsx",
                                           undated_file_name(current_goma))
rio::export(table_hz_over_time_decisions,
            file.path("produced_xlsx", table_hz_over_time_decisions_file_name))

### past 3 weeks by health zone total
table_hz_total_recent_decisions_file_name <- sprintf("%stable_hz_decisions_total_recent.xlsx",
                                        undated_file_name(current_goma))
rio::export(table_hz_total_recent_decisions,
            file.path("produced_xlsx", table_hz_total_recent_decisions_file_name))

### past 3 weeks by health zone over time 
table_hz_over_time_recent_decisions_file_name <- sprintf("%stable_hz_decisions_over_time_recent.xlsx",
                                               undated_file_name(current_goma))
rio::export(table_hz_over_time_recent_decisions,
            file.path("produced_xlsx", table_hz_over_time_recent_decisions_file_name))

### since database start by health area total
table_ha_total_decisions_file_name <- sprintf("%stable_ha_decisions_total.xlsx",
                                               undated_file_name(current_goma))
rio::export(table_ha_total_decisions_file_name,
            file.path("produced_xlsx", table_ha_total_decisions_file_name))

### since database start by health area over time
table_ha_over_time_decisions_file_name <- sprintf("%stable_ha_decisions_over_time.xlsx",
                                               undated_file_name(current_goma))
rio::export(table_ha_over_time_decisions,
            file.path("produced_xlsx", table_ha_over_time_decisions_file_name))

### past 3 weeks by health area total
table_ha_total_recent_decisions_file_name <- sprintf("%stable_ha_decisions_total_recent.xlsx",
                                               undated_file_name(current_goma))
rio::export(table_ha_total_recent_decisions,
            file.path("produced_xlsx", table_ha_total_recent_decisions_file_name))

### past 3 weeks by health area over time
table_ha_over_time_recent_decisions_file_name <- sprintf("%stable_ha_decisions_over_time_recent.xlsx",
                                               undated_file_name(current_goma))
rio::export(table_ha_over_time_recent_decisions,
            file.path("produced_xlsx", table_ha_over_time_recent_decisions_file_name))

```

Click on the following links to open the files (only works if the files above
have been generated and are in the same folder as this document):

**Cleaned Alerts Database:**
- [cleaned_alerts_database_goma.xlsx](produced_xlsx/cleaned_alerts_database_goma.xlsx)

**Alert Validation Databases:**
- [alerts_goma_table_validation.xlsx](produced_xlsx/alerts_goma_table_validation.xlsx)
- [alerts_goma_table_validation_recent.xlsx](produced_xlsx/alerts_goma_table_validation_recent.xlsx)
- [alerts_goma_table_hz_validation_total.xlsx](produced_xlsx/alerts_goma_table_hz_validation_total.xlsx)
- [alerts_goma_table_hz_validation_over_time.xlsx](produced_xlsx/alerts_goma_table_hz_validation_over_time.xlsx)
- [alerts_goma_table_hz_validation_total_recent.xlsx](produced_xlsx/alerts_goma_table_hz_validation_total_recent.xlsx)
- [alerts_goma_table_hz_validation_over_time_recent.xlsx](produced_xlsx/alerts_goma_table_hz_validation_over_time_recent.xlsx)
- [alerts_goma_table_ha_validation_total.xlsx](produced_xlsx/alerts_goma_table_ha_validation_total.xlsx)
- [alerts_goma_table_ha_validation_over_time.xlsx](produced_xlsx/alerts_goma_table_ha_validation_over_time.xlsx)
- [alerts_goma_table_ha_validation_total_recent.xlsx](produced_xlsx/alerts_goma_table_ha_validation_total_recent.xlsx)
- [alerts_goma_table_ha_validation_over_time_recent.xlsx](produced_xlsx/alerts_goma_table_ha_validation_over_time_recent.xlsx)

**Alert Origins Databases:**
- [alerts_goma_table_origins.xlsx](produced_xlsx/alerts_goma_table_origins.xlsx)
- [alerts_goma_table_origins_recent.xlsx](produced_xlsx/alerts_goma_table_origins_recent.xlsx)
- [alerts_goma_table_hz_origins_total.xlsx](produced_xlsx/alerts_goma_table_hz_origins_total.xlsx)
- [alerts_goma_table_hz_origins_over_time.xlsx](produced_xlsx/alerts_goma_table_hz_origins_over_time.xlsx)
- [alerts_goma_table_hz_origins_total_recent.xlsx](produced_xlsx/alerts_goma_table_hz_origins_total_recent.xlsx)
- [alerts_goma_table_hz_origins_over_time_recent.xlsx](produced_xlsx/alerts_goma_table_hz_origins_over_time_recent.xlsx)
- [alerts_goma_table_ha_origins_total.xlsx](produced_xlsx/alerts_goma_table_ha_origins_total.xlsx)
- [alerts_goma_table_ha_origins_over_time.xlsx](produced_xlsx/alerts_goma_table_ha_origins_over_time.xlsx)
- [alerts_goma_table_ha_origins_total_recent.xlsx](produced_xlsx/alerts_goma_table_ha_origins_total_recent.xlsx)
- [alerts_goma_table_ha_origins_over_time_recent.xlsx](produced_xlsx/alerts_goma_table_ha_origins_over_time_recent.xlsx)

**Alert Validation Decisions Databases:**
- [alerts_goma_table_decisions.xlsx](produced_xlsx/alerts_goma_table_decisions.xlsx)
- [alerts_goma_table_decisions_recent.xlsx](produced_xlsx/alerts_goma_table_decisions_recent.xlsx)
- [alerts_goma_table_hz_decisions_total.xlsx](produced_xlsx/alerts_goma_table_hz_decisions_total.xlsx)
- [alerts_goma_table_hz_decisions_over_time.xlsx](produced_xlsx/alerts_goma_table_hz_decisions_over_time.xlsx)
- [alerts_goma_table_hz_decisions_total_recent.xlsx](produced_xlsx/alerts_goma_table_hz_decisions_total_recent.xlsx)
- [alerts_goma_table_hz_decisions_over_time_recent.xlsx](produced_xlsx/alerts_goma_table_hz_decisions_over_time_recent.xlsx)
- [alerts_goma_table_ha_decisions_total.xlsx](produced_xlsx/alerts_goma_table_ha_decisions_total.xlsx)
- [alerts_goma_table_ha_decisions_over_time.xlsx](produced_xlsx/alerts_goma_table_ha_decisions_over_time.xlsx)
- [alerts_goma_table_ha_decisions_total_recent.xlsx](produced_xlsx/alerts_goma_table_ha_decisions_total_recent.xlsx)
- [alerts_goma_table_ha_decisions_over_time_recent.xlsx](produced_xlsx/alerts_goma_table_ha_decisions_over_time_recent.xlsx)



<!-- ======================================================= -->
<!-- ======================================================= -->
<!-- ======================================================= -->

# System information {.tabset .tabset-fade .tabset-pills}

## Outline

The following information documents the system on which the document was
compiled.


## System 

This provides information on the operating system.

```{r system_info}
Sys.info()
```

## R environment

This provides information on the version of R used:

```{r R_session}
R.version
```


## R packages

This provides information on the packages used:

```{r R_pkg}
sessionInfo()
```
